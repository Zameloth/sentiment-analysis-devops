trigger:
  - main

variables:
  # Variables pour Azure
  azureSubscription: 'myserviceconnection'
  resourceGroupName: 'sentimentApi'
  location: 'westeurope'

  # Variables pour le registre de conteneurs
  containerRegistry: 'dockerhub'

  # Variables pour les images Docker
  apiImageName: 'sentiment-api'
  modelImageName: 'sentiment-model'
  tag: '$(Build.BuildId)'

  resource_group_name: 'sentimentApi'  # Correspond à votre variable Terraform
  storage_account_name: 'sentimentapistate'


stages:
  - stage: Deploy
    jobs:
      - job: DeployInfrastructure
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          # Téléchargement des artefacts de build si nécessaire
          - download: current
          - task: TerraformInstaller@1
            inputs:
              terraformVersion: '1.7.2'

          - task: AzureCLI@2
            displayName: 'Create Azure Storage for Terraform State'
            inputs:
              azureSubscription: '$(azureSubscription)'  # Remplacez par votre nom de connexion de service
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                # Créer le groupe de ressources
                az group create --name $(resource_group_name) --location $(location)

                # Créer le compte de stockage
                az storage account create \
                  --name $(storage_account_name) \
                  --resource-group $(resource_group_name) \
                  --location $(location) \
                  --sku Standard_LRS

                # Créer le conteneur
                az storage container create \
                  --name tfstate \
                  --account-name $(storage_account_name)


              # Initialisation de Terraform
          - task: TerraformTaskV4@4
            inputs:
              provider: 'azurerm'
              command: 'init'
              workingDirectory: '$(System.DefaultWorkingDirectory)/infra'
              backendServiceArm: '$(azureSubscription)'
              backendAzureRmResourceGroupName: '$(resourceGroupName)'
              backendAzureRmStorageAccountName: 'sentimentapistate'
              backendAzureRmContainerName: 'tfstate'
              backendAzureRmKey: 'sentimentapi/terraform.tfstate'

          - task: AzureCLI@2
            displayName: 'Import Existing Resources'
            inputs:
              azureSubscription: '$(azureSubscription)'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              workingDirectory: '$(System.DefaultWorkingDirectory)/infra'
              inlineScript: |
                # Récupérer l'ID de souscription
                SUBSCRIPTION_ID=$(az account show --query id -o tsv)

                # Importer le groupe de ressources
                terraform import \
                  azurerm_resource_group.rg \
                  "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$(resourceGroupName)"

                # Note: Ajoutez d'autres commandes d'importation si nécessaire


          # Plan Terraform
          - task: TerraformTaskV4@4
            inputs:
              provider: 'azurerm'
              command: 'plan'
              workingDirectory: '$(System.DefaultWorkingDirectory)/infra'
              environmentServiceNameAzureRM: '$(azureSubscription)'
              commandOptions: '-var="image_tag=$(tag)"'

          # Application Terraform
          - task: TerraformTaskV4@4
            inputs:
              provider: 'azurerm'
              command: 'apply'
              workingDirectory: '$(System.DefaultWorkingDirectory)/infra'
              environmentServiceNameAzureRM: '$(azureSubscription)'
              commandOptions: '-auto-approve -var="image_tag=$(tag)"'
  - stage: Build
    dependsOn: Deploy
    jobs:
      - job: BuildAndPublish
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          # Installation des dépendances Terraform
          - task: TerraformInstaller@0
            inputs:
              terraformVersion: 'latest'
          # Connexion au registre Docker
          - task: Docker@2
            displayName: 'Docker Login'
            inputs:
              command: login
              containerRegistry: '$(containerRegistry)'


          # Construction et push de l'image API
          - task: Docker@2
            displayName: 'Build and Push API Image'
            inputs:
              containerRegistry: '$(containerRegistry)'
              repository: '$(apiImageName)'
              command: 'buildAndPush'
              Dockerfile: 'api/Dockerfile'
              tags: |
                $(tag)
                latest

          # Construction et push de l'image Model
          - task: Docker@2
            displayName: 'Build and Push Model Image'
            inputs:
              containerRegistry: '$(containerRegistry)'
              repository: '$(modelImageName)'
              command: 'buildAndPush'
              Dockerfile: 'model/Dockerfile'
              tags: |
                $(tag)
                latest


  - stage: HealthCheck
    dependsOn: Deploy
    jobs:
      - job: TestEndpoints
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: PowerShell@2
            inputs:
              targetType: 'inline'
              script: |
                # Test API Health
                $apiHealth = Invoke-RestMethod -Uri "https://$(apiWebAppName).azurewebsites.net/health"
                if ($apiHealth.status -ne "ok") { throw "API health check failed" }
                
                # Test Model Service Health
                $modelHealth = Invoke-RestMethod -Uri "https://$(modelWebAppName).azurewebsites.net/health"
                if ($modelHealth.status -ne "ok") { throw "Model service health check failed" }
